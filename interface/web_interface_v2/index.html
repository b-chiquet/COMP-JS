<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="A front-end template that helps you build fast, modern mobile web apps.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Compilation interactive</title>

    <link rel="shortcut icon" href="images/favicon.png">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.yellow-deep_purple.min.css">
    <link rel="stylesheet" href="styles.css">
	
	
	<script src="https://use.fontawesome.com/b22540b48d.js"></script>

	
    <style>
        #view-source {
            position: fixed;
            display: block;
            right: 0;
            bottom: 0;
            margin-right: 40px;
            margin-bottom: 40px;
            z-index: 900;
        }
		
		.mdl-cell--padding {
			padding: 20px;
		}
		
		.mdl-typography--title--margin {
			margin-left: 10px;
		}
		
		.mdl-cell--border-bottom {
			border-bottom: lightgray solid 2px;
		}
		
		
		.code-line--content {
			display: inline-block;
			font-family: 'Consolas', sans-serif;
			color: gray;
			margin-left: 10px;
		}
		
		.code-line--content-system {
			display: inline-block;
			font-family: 'Consolas', sans-serif;
			color: gray;
			opacity: 0.8;
			margin-left: 10px;
		}
		
		.tab {
			display: inline-block;
			margin-left: 20px;
		}
		
		.separator {
			height: 4px; width: 200px; background-color: white; margin: auto;margin-top: 50px;margin-bottom: 75px;
		}
		
		.code-line--number {
			font-family: 'Consolas', sans-serif;
			color: gray;
		}
		
		.code-line--number::after {
			content: '> ';
		}
		
		
		
		#compilation-loading {
			position: fixed;
			top: 0px; 
			left: 0px;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.9);
			z-index:11111;
			color: white;
			text-align: center;
			padding-top: 20%;
			visibility: hidden;
		}
    </style>
</head>

<body>
    <div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-drawer mdl-layout--fixed-header">
        <header class="demo-header mdl-layout__header mdl-color--grey-100 mdl-color-text--grey-600">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout-title">Compilateur WHILE vers JavaScript</span>
                <div class="mdl-layout-spacer"></div>
            </div>
        </header>
        <div class="demo-drawer mdl-layout__drawer mdl-color--brown-900 mdl-color-text--blue-grey-50">
            <header class="demo-drawer-header">

            </header>
            <nav class="demo-navigation mdl-navigation mdl-color--brown-800">
                <a class="mdl-navigation__link" href=""><i class="mdl-color-text--white-400 material-icons" role="presentation">home</i>Lien du cours</a>
                <a class="mdl-navigation__link" href=""><i class="mdl-color-text--white-400 material-icons" role="presentation">delete</i>Réinitialiser</a>
                <a class="mdl-navigation__link" href=""><i class="mdl-color-text--white-400 material-icons" role="presentation">bug_report</i>Signaler un bug</a>
                <a class="mdl-navigation__link" href=""><i class="mdl-color-text--white-400 material-icons" role="presentation">code</i>Voir les sources</a>
                <div class="mdl-layout-spacer"></div>
                <a class="mdl-navigation__link" href=""><i class="mdl-color-text--white-400 material-icons" role="presentation">help_outline</i><span class="visuallyhidden">Help</span></a>
            </nav>
        </div>
        <main class="mdl-layout__content mdl-color--grey-100">
            <div class="mdl-grid">

                <div class="mdl-cell mdl-cell--6-col-desktop mdl-cell--8-col-tablet mdl-grid">
				
					<div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--top mdl-cell--padding mdl-grid">

						<div class="mdl-cell mdl-cell--3-col mdl-color--orange mdl-color-text--white mdl-typography--text-center">
							<div class="mdl-typography--display-3">1</div>
						</div>
						<div class="mdl-cell mdl-cell--9-col mdl-cell--padding mdl-cell--border-bottom">
							<div class="mdl-typography--title mdl-typography--title--margin">Input</div>
							<p>Paste or write WHILE code below</p>
						</div>
						
						<!-- end header -->
						
						<div id="input-area" class="mdl-cell mdl-color--grey-200 mdl-cell--12-col mdl-cell--border-bottom mdl-cell--padding">
							<div class="code-line">
								<b class="code-line--number">1</b>
								<span class="code-line--content">function estPair:</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">2</b>
								<span class="code-line--content">
									<span class="tab"></span>
									read X;
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">3</b>
								<span class="code-line--content">
									<span class="tab"></span>
									%
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">4</b>
								<span class="code-line--content">
									<span class="tab"></span>
									RES = ((X % 2) == 0);
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">5</b>
								<span class="code-line--content">
									<span class="tab"></span>
									%
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">6</b>
								<span class="code-line--content">
									<span class="tab"></span>
									write RES;
								</span>
							</div>
							<br/>
						</div>
						
						<!-- start footer -->
						
						<div class="mdl-cell mdl-cell--12-col mdl-typography--text-right">
							<button id="user-action--import" class="mdl-button mdl-js-button">Importer</button>
							<div class="mdl-tooltip mdl-tooltip--large" for="user-action--import">Importer le contenu d'un fichier WHILE</div>
							<button id="user-action--paste" class="mdl-button mdl-js-button" onclick="pasteCode()">Coller</button>			
							<div class="mdl-tooltip mdl-tooltip--large" for="user-action--paste">Coller le code issu du presse-papier</div>
							<button id="user-action--compile" class="mdl-button mdl-js-button mdl-color-text--orange" onclick="compileOnServer()">Compiler</button>
							<div class="mdl-tooltip mdl-tooltip--large" for="user-action--compile">Compiler le code en JavaScript fonctionnel</div>
						</div>
						
					</div>
                </div>
				
				<div class="mdl-cell mdl-cell--6-col-desktop mdl-cell--8-col-tablet mdl-grid">
				
					<div class="mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--top mdl-cell--12-col  mdl-cell--padding mdl-grid">

						<div class="mdl-cell mdl-cell--3-col mdl-color-text--white mdl-color--blue mdl-typography--text-center">
							<div class="mdl-typography--display-3">2</div>
						</div>
						<div class="mdl-cell mdl-cell--9-col mdl-color-text--black mdl-cell--padding mdl-cell--border-bottom">
							<div class="mdl-typography--title mdl-typography--title--margin">Output</div>
							<p>Obtain the matching JAVASCRIPT code here</p>
						</div>
						
						<!-- end header -->
						
						<div id="output-area" class="mdl-cell mdl-cell--12-col mdl-color--grey-200 mdl-cell--border-bottom mdl-typography--text-left mdl-cell--padding" style="min-height: 200px;">
							<!--<div class="code-line">
								<b class="code-line--number">1</b>
								<span class="code-line--content">
								var whileFunctions = {
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">2</b>
								<span class="tab"></span>
								<span class="code-line--content">estPair: {</span>
							</div>
							
							<div class="code-line">
								<b class="code-line--number">3</b>
								<span class="code-line--content">
									<span class="tab"></span><span class="tab"></span>
									code: function(args){
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">4</b>
								<span class="code-line--content">
									<span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span>
									const res = ((args[0] % 2) == 0);
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">5</b>
								<span class="code-line--content">
									<span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span>
									return res;
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">6</b>
								<span class="code-line--content">
									<span class="tab"></span><span class="tab"></span>
									},
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">7</b>
								<span class="code-line--content">
									<span class="tab"></span><span class="tab"></span>
									metadata: {
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">8</b>
								<span class="code-line--content">
									<span class="tab"></span><span class="tab"></span><span class="tab"></span>
									argsIn: 1,
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">9</b>
								<span class="code-line--content">
									<span class="tab"></span><span class="tab"></span><span class="tab"></span>
									argsOut: 1
								</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">10</b>
								<span class="code-line--content"><span class="tab"></span><span class="tab"></span>}</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">11</b>
								<span class="code-line--content"><span class="tab"></span>}</span>
							</div>
							<div class="code-line">
								<b class="code-line--number">12</b>
								<span class="code-line--content">};</span>
							</div>-->
							<br/>
						</div>
						
						<!-- start footer -->
						
						<div class="mdl-cell mdl-cell--12-col mdl-typography--text-right">
							<button id="user-action--copy" class="mdl-button mdl-js-button">Copier</button>
							<div class="mdl-tooltip mdl-tooltip--large" for="user-action--copy">Copier le code dans le presse-papier</div>
							<button id="user-action--export" class="mdl-button mdl-js-button mdl-color-text--blue">Sauvegarder</button>
							<div class="mdl-tooltip mdl-tooltip--large" for="user-action--export">Exporter en tant que fichier local</div>
						</div>
					</div>
                </div>
				
				<div class="mdl-cell mdl-cell--8-col-desktop mdl-cell--2-offset mdl-cell--6-col-tablet mdl-cell--1-offset-tablet mdl-grid">
				
					<div class="mdl-color--white  mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--padding mdl-grid">

						<div class="mdl-cell mdl-cell--3-col mdl-color-text--white mdl-color--red mdl-typography--text-center">
							<div class="mdl-typography--display-3">3</div>
						</div>
						<div class="mdl-cell mdl-cell--9-col mdl-color-text--black mdl-cell--padding mdl-cell--border-bottom">
							<div class="mdl-typography--title mdl-typography--title--margin">Console</div>
							<p>Interact there with the JavaScript functions generated</p>
							
							
						</div>
						
						<!-- end header -->
						<!-- start functions -->
						
						<div id="test-area" class="mdl-cell mdl-cell--12-col mdl-cell--padding mdl-cell--border-bottom">
							<!--<div class="dynamic-function">
								<button class="mdl-button mdl-js-button mdl-color-text--red" onclick="testDynamicFnc('estPair')">estPair</button>
								<span class="tab"></span><i>Tester la fonction 'estPair' (1 argument en entrée, 1 résultat en sortie)</i>
							</div>-->
							
						</div>
						
						<!-- end functions -->
						<!-- start console -->
						
						<div id="log-area" class="mdl-cell mdl-cell--12-col mdl-color--grey-200 mdl-cell--border-bottom mdl-typography--text-left mdl-cell--padding">
							<!--
							<div class="code-line">
								<b class="code-line--number">11:27:40:272</b>
								<span class="code-line--content">
									results : [false]
								</span>
							</div>
							
							<div class="code-line">
								<b class="code-line--number">11:27:39:863</b>
								<span class="code-line--content code-line--content-system">
									Function estPair called with params : [13]
								</span>
							</div>-->
							
							<br/>
						</div>
						
						
					</div>
                </div>
            </div>
        </main>
    </div>
	
	<div id="compilation-loading" style="">
		
		<i class="fa fa-spinner fa-spin fa-4x fa-fw"></i>
		<span class="sr-only">Loading...</span>
		<h3>Compilation processing</h3>
		<div class="separator"></div>
		<p>Code is sent to an instance of a local Java server</p>
		<p>Which is responsible for returning the JavaScript version of the While code provided</p>
		<p>The more complex your code is and the longer it will last</p>
		
	</div>

    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>

	<script type="text/javascript">
	
	let output, input, whileFunctions;
	
	
	// 0°) Code par défaut
	input = `
	function foisDeux:
		read X;
		%
		RES = X * 2;
		%
		write RES;
	`;
	
	
	// 1°) Test de la fonction eval (appel de la fonction hello dynamiquement créée)
	eval("var hello = function(){console.log('hello !')};");
	hello();
	
	// 2°) Test de la fonction eval avec le code JavaScript généré
	var result = `
		var whileFunctions = {
			estPair: {
				code: function(args){
					const res = ((args[0]%2) == 0);
					return res;
				},
				metadata: {
					argsIn: 1,
					argsOut: 1
				}
			}
		};
	`;
	
	

	
	
	</script>
	<script type="text/javascript">
	
	
	var showLoading = function() {
		document.getElementById("compilation-loading").style.visibility = "visible";
	};
	
	var hideLoading = function() {
		document.getElementById("compilation-loading").style.visibility = "hidden";
	};
	
	var changeArea = function(area, data) {
		var theArea = document.getElementById(area);
		
		while(theArea.firstChild){theArea.removeChild(theArea.firstChild);}
		
		var tabs = [];
		var code = data.split("\n");
		var line = "";
		var DOMcodeline, DOMcodelinenumber, DOMcodelinecontent, DOMtab;
		
		for(var i = 0; i < code.length; i++){
		
			DOMcodeline = document.createElement("div");
			DOMcodeline.className = "code-line";
			
			DOMcodelinenumber = document.createElement("b");
			DOMcodelinenumber.className = "code-line--number";
			DOMcodelinenumber.appendChild(document.createTextNode(i+1));
			
			
			DOMcodelinecontent = document.createElement("span");
			DOMcodelinecontent.className = "code-line--content";
											
			tabs = code[i].split("\t");
			for(var j = 1; j < tabs.length; j++){
				DOMtab = document.createElement("span");
				DOMtab.className = "tab";
				DOMcodelinecontent.appendChild(DOMtab);
			}
			line = tabs[tabs.length-1];
			DOMcodelinecontent.appendChild(document.createTextNode(line));
			
			DOMcodeline.appendChild(DOMcodelinenumber);
			DOMcodeline.appendChild(DOMcodelinecontent);
									
			theArea.appendChild(DOMcodeline);
		}
		
	};
	
	var changeOutput = function() { changeArea("output-area", output); }
	var changeInput = function() { changeArea("input-area", input); }
	
	
	var modifyCode = function(){
		// display blank textarea

	};
	
	// Function sending input to server and handling response
	var compileOnServer = function(){
		
		var formData = new FormData();
		formData.append("code", input);
		var request = new XMLHttpRequest();
		request.open("POST", "http://localhost:3333", true);
		request.setRequestHeader("Content-Type", "multipart/form-data");
		
		showLoading();
		
		request.onreadystatechange = function() {
			if(request.readyState == 4 && request.status == 200) {
			
				output = JSON.parse(request.responseText)["code"];
				setTimeout(hideLoading, 2000);
				changeOutput();
				evalOutput();
			}
		}
		
		request.send(formData);
			
	};
	
	
	
	
	// Function giving access to the output code into the browser sandbox
	var evalOutput = function () {
		
		eval(output);
		
		console.log(whileFunctions);
		
		var theArea = document.getElementById("test-area");
		
		while(theArea.firstChild){theArea.removeChild(theArea.firstChild);}
		
		
		var DOMfncblock, DOMbtn, DOMtab, DOMdescription, DOMdescriptiontext, desctext;
		
		for(var k in whileFunctions) {
		   console.log(k, whileFunctions[k]);
		   
		   DOMfncblock = document.createElement("div");
		   DOMfncblock.className = "dynamic-function";
		   
		   DOMbtn = document.createElement("button");
		   DOMbtn.className = "mdl-button mdl-js-button mdl-color-text--red";
		   DOMbtn.onclick = function() { testDynamicFnc(k); };
		   DOMbtn.appendChild(document.createTextNode(k));
		   
		   DOMtab = document.createElement("span");
		   DOMtab.className = "tab";
		   
		   DOMdescription = document.createElement("i");
		   desctext = "Tester la fonction '" + k + "' (" + whileFunctions[k]["metadata"]["argsIn"] + " in, " + whileFunctions[k]["metadata"]["argsOut"] + " out)";
		   DOMdescriptiontext = document.createTextNode(desctext);
		   DOMdescription.appendChild(DOMdescriptiontext);
		   
		   DOMfncblock.appendChild(DOMbtn);
		   DOMfncblock.appendChild(DOMtab);
		   DOMfncblock.appendChild(DOMdescription);
		   
		   theArea.appendChild(DOMfncblock);
		}
	
	};
	
	var addLogEntry = function (text, isDarker){
		var theArea = document.getElementById('log-area');
		
		var DOMentry = document.createElement("div");
		DOMentry.className = "code-line";
		var DOMtime = document.createElement("b");
		DOMtime.className = "code-line--number";
		
		var d = new Date();
		var time = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds() + "." + d.getMilliseconds();
		
		DOMtime.appendChild(document.createTextNode(time));
	
		DOMmsg = document.createElement("span");
		if(isDarker){
			DOMmsg.className = "code-line--content code-line--content-system";
		} else {
			DOMmsg.className = "code-line--content";
		}
		DOMmsg.appendChild(document.createTextNode(text));
		
		DOMentry.appendChild(DOMtime);
		DOMentry.appendChild(DOMmsg);
		theArea.append(DOMentry);
	
	}
	

	// Fonction permettant l'utilisation d'une fonction de maniere dynamique
	var testDynamicFnc = function(fncName){
		
		eval(output);
		
		fncName = fncName || "estPair";
	
		// Extraction du nombre de parametres en entree
		var params = [];
		for(var i = 0; i < whileFunctions[fncName]['metadata']['argsIn']; i ++){
			params.push(prompt('Argument ' + i + ' ?'));
		}
		
		addLogEntry("Function '" + fncName + "' called with params : " + params, true);
		
		// Obtention du resultat
		var results = whileFunctions[fncName].code(params);
		addLogEntry("results : " + results, false);
	};
	
	</script>
</body>
</html>